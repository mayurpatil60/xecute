@model xpPortal.Models.Query

@{
    Layout = "~/Views/Shared/LayoutMaster.cshtml";
}

<script src="~/Scripts/jquery-3.2.1.js"></script>


@Html.AntiForgeryToken()

<section class="panel">
    <header class="panel-heading header-class">
        Queries
        <span class="tools pull-right">
            <a href="javascript:;" class="fa fa-chevron-down"></a>
        </span>
    </header>
    <div class="panel-body">
        <div class="form-horizontal">
            
            @Html.ValidationSummary(true, "", new { @class = "text-danger" })

            <div class="form-group">
                @*@Html.LabelFor(model => model.QueryDetail, htmlAttributes: new { @class = "control-label col-md-2" })*@
                <div style="margin-left:1%"> <h4>Ask here:</h4></div>
                <div class="col-md-10">
                    @Html.TextAreaFor(model => model.QueryDetail, 5, 125, htmlAttributes: new { @class = "form-control", @id = "txtQueryDetail" })
                    @Html.ValidationMessageFor(model => model.QueryDetail, "", new { @class = "text-danger" })
                </div>
                <div class="col-md-4" style="float:right">
                        <input value="Submit" class="btn btn-primary" id="btnSubmitQuery" style="width:30%;margin-left:15%;margin-top:3%" />
                </div>
            </div>

        </div>
    </div>
</section>
<div class="row" id="QueryContainer">
    <div class="col-sm-12">
        <div class="timeline">
            <article class="timeline-item alt">
                <div class="text-right">
                    <div class="time-show first">
                        <a style="cursor:default" class="btn btn-success">Queries</a>
                    </div>
                </div>
            </article>
        </div>
    </div>
</div>

<script>
    var userQueryElement = $('<article class="timeline-item alt">' +
            '<div class="timeline-desk">' +
                '<div class="panel">' +
                    '<div class="panel-body">' +
                        '<span class="arrow-alt"></span>' +
                        '<span class="timeline-icon yellow">' +
                            '<i class="fa fa-comment-o"></i>' +
                        '</span>' +
                        '<span class="timeline-date">12:25 am</span>' +
                        '<h1 class="yellow">1 hour ago</h1>' +
                        '<p>Thanks. </p>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</article>');

    var queryReplyElement = $('<article class="timeline-item">' +
        '<div class="timeline-desk">' +
            '<div class="panel">' +
                '<div class="panel-body">' +
                    '<span class="arrow"></span>' +
                    '<span class="timeline-icon light-green">' +
                        '<i class="fa fa-comments"></i>' +
                    '</span>' +
                    '<span class="timeline-date">12:25 am</span>' +
                    '<h1 class="yellow">1 hour ago</h1>' +
                    '<p>Thanks. </p>' +
                '</div>' +
            '</div>' +
        '</div>' +
    '</article>');
    var options = { year: 'numeric', month: 'long', day: 'numeric' };
    $(document).ready(function () {

        GetUserSpecificQueriesAndReplies();

    });

    $('#btnSubmitQuery').click(function () {

        var url = "../Joinee/SubmitQuery";

        $.ajax({
            url: url,
            type: "POST",
            data: JSON.stringify({ subject: $('#txtSubject').val(), queryDetail: $('#txtQueryDetail').val() }),
            datatype: "JSON",
            contentType: 'application/json',
            traditional: true,
            success: function (data) {
                debugger
                if (data > 0) {
                    var content = $('#txtQueryDetail').val();

                    var ele = $('.timeline').find('article')[0];
                    var elementClone = $(userQueryElement).clone();
                    $(elementClone).attr('id', 999);
                    $(elementClone).find('p').html(content);
                    $(elementClone).find('h1').html(new Date().toLocaleDateString("en-US", options));
                    $(elementClone).insertAfter($(ele));
                    $('#QueryContainer').show();

                    $('#txtSubject').val('');
                    $('#txtQueryDetail').val('');
                }
            }
        });
    });

    function GetUserSpecificQueriesAndReplies() {
        var url = "../Joinee/GetUserSpecificQueriesAndReplies";

        $.ajax({
            url: url,
            type: "POST",
            datatype: "JSON",
            contentType: 'application/json',
            traditional: true,
            success: function (data) {
                debugger
                if (data.length > 0) {
                    $('#QueryContainer').show();
                    DisplayQuerySection(data);

                }
                else {
                    $('#QueryContainer').hide();
                }

            }
        });
    }

    function DisplayQuerySection(data) {

        for (var i = 0, j = 0; i < data.length; i++, j++) {
            var query = data[i].QueryDetail;
            var createdDateTime = data[i].CreatedDateTime;

            var ele = $('.timeline').find('article')[0];
            var elementClone = $(userQueryElement).clone();
            $(elementClone).attr('id', i);
            $(elementClone).find('p').html(query);
            $(elementClone).find('h1').html(new Date(createdDateTime).toLocaleDateString("en-US", options));
            $(elementClone).insertAfter($(ele));

            if (data[i].Reply != '') {
                var queryReply = data[i].Reply;
                var queryReplyDateTime = data[i].ReplyDateTime;

                var qelementClone = $(queryReplyElement).clone();
                $(qelementClone).attr('id', j);

                $(qelementClone).find('p').html(queryReply);
                $(qelementClone).find('h1').html(new Date(queryReplyDateTime).toLocaleDateString("en-US", options));
                $(qelementClone).insertAfter($(ele));
            }

        }
    }


</script>
